# NeRF

## 介绍

**NeRF**（Neural Radiance Fields，神经辐射场）是一种基于神经网络的先进3D重建技术，它能够从2D图像生成高质量的3D场景。

[NeRF详解-CSDN博客](https://blog.csdn.net/leviopku/article/details/129933938)

**COLMAP** 是一个流行的、开源的三维重建和结构光束调整（Structure from Motion, SfM）工具包，广泛应用于计算机视觉和计算机图形学领域。它可以将一组二维图像转换为三维模型，并提取相机姿态信息。COLMAP 的核心功能包括**图像匹配**、**特征提取**、**特征匹配**、**稀疏重建**和**稠密重建**。

[Tutorial — COLMAP 3.11-dev documentation](https://colmap.github.io/tutorial.html)

COLMAP 和 NeRF 可以互补使用。COLMAP 可以先从多视角图像中构建稀疏三维点云和相机参数，然后这些信息可以用来初始化 NeRF 模型的训练。NeRF 可以利用这些初始信息，进一步优化和细化三维重建结果，生成高质量的三维场景。

## 实验流程

1. 数据：一组多视图2D图像放在同一个文件夹
2. 先把图像在colmap跑出来
3. 跑 colmap2nerf.py 

## Colmap

### 工作流程

首先，启动 COLMAP 的图形用户界面。COLMAP 提供了一个自动重建工具，该工具只需一个输入图像的文件夹，就可以在工作区文件夹中生成**稀疏和稠密重建**。点击界面中的 Reconstruction（重建） > Automatic Reconstruction（自动重建），并指定相关选项。输出结果将写入到工作区文件夹中。例如，如果你的图像位于 path/to/project/images 目录下，你可以选择 path/to/project 作为工作区文件夹，运行自动重建工具后，该文件夹的结构可能类似于以下内容：

![image](C:\Users\董子能\AppData\Roaming\marktext\images\2024-08-05-14-22-55-image.png)

在这里，path/to/project/sparse 文件夹包含了所有重建组件的稀疏模型，而 path/to/project/dense 文件夹包含了它们对应的稠密模型。稠密点云文件 fused.ply 可以通过 COLMAP 中的 File（文件） > Import model from ...（从...导入模型）导入，而稠密网格模型则需要使用诸如 Meshlab 的外部查看器进行可视化。
![image](https://github.com/user-attachments/assets/5664d95e-6eaf-4476-9899-dde98308d6ec)


### 数据

- 捕获**具有良好质感**的图像。避免完全无纹理的图像 （例如，一堵白墙或空桌子）。如果场景包含的次数不足 纹理本身，您可以放置额外的背景对象，例如 海报等

- 在**相似的照明**条件下捕获图像。避免高动态 范围场景（例如，带有阴影的逆射太阳的照片或图片 通过门/窗）。避免在有光泽的表面上出现镜面反射。

- 捕获具有**高度视觉重叠**的图像。确保每个对象都是 至少在 3 张图像中看到 - 图像越多越好。

- 从**不同的视点**捕获图像。不要仅仅只是在一个位置旋转相机，同时注意不是图像越多越好，图像太多可能会导致速度变慢。

### 参数

对于一般用户来说，COLMAP 只需要几个步骤即可完成标准重建。对于更有经验的用户，程序提供了许多不同的参数，但其中只有一部分是初学者直观理解的。通常情况下，程序无需修改任何参数即可运行。默认参数是在重建的鲁棒性/质量和速度之间进行权衡后选择的。你可以通过选择 Extras（附加功能） > Set options for ... data（为...数据设置选项）来为不同的重建场景设置“最佳”选项。如果不确定选择哪些设置，请坚持使用默认值。源代码中包含了有关所有参数的更多文档。

### 导入和导出

COLMAP 提供了多种导出选项以供进一步处理。为了实现最大的灵活性，推荐选择 File（文件）> Export（导出）以导出当前查看的模型，或选择 File（文件）> Export all（导出所有）以导出所有重建的模型，从而将重建结果导出为 COLMAP 的数据格式。模型将使用单独的文本文件导出到选定的文件夹中，分别保存重建的相机、图像和点。导出为 COLMAP 的数据格式后，您可以重新导入重建结果，以便稍后进行可视化、图像去畸变或从中断处继续现有的重建（例如，在导入和匹配新图像之后）。要导入模型，请选择 File（文件）> Import（导入）并选择导出文件夹路径。

此外，您还可以选择 File（文件）> Export as...（导出为...）将模型导出为其他多种格式，如 Bundler、VisualSfM 1、PLY 或 VRML。COLMAP 还可以通过选择 File（文件）> Import From...（从...导入）来可视化带有 RGB 信息的纯 PLY 点云文件。有关导出模型格式的更多信息，请参见这里。

### 数据库管理

您可以在数据库管理工具中查看和管理导入的相机、图像和特征匹配。选择 Processing（处理）> Manage database（管理数据库）。在打开的对话框中，您可以看到导入的图像和相机列表。通过点击 Show image（显示图像）和 Overlapping images（重叠图像），您可以查看每个图像的特征和匹配。在数据库表中，通过双击特定的单元格，可以修改单个条目。请注意，任何对数据库的更改只有在点击 Save（保存）后才会生效。

要在任意图像组之间共享内在相机参数，请选择一个或多个图像，选择 Set camera（设置相机）并设置 camera_id，对应于相机表中的唯一 camera_id 列。您还可以添加具有特定参数的新相机。通过将 prior_focal_length 标志设置为 0 或 1，可以提示重建算法是否应该信任焦距值。如果有事先的实验室校准，您需要将此值设置为 1。如果没有焦距的先验知识，建议将此值设置为 1.25 * max(width_in_px, height_in_px)。

数据库管理工具功能有限，要完全控制数据，您必须直接修改 SQLite 数据库（请参阅数据库格式）。通过直接访问数据库，您可以仅使用 COLMAP 进行特征提取和匹配，或者导入自己的特征和匹配，仅使用 COLMAP 的增量重建算法。

### 图形和命令行界面

COLMAP 的大多数功能都可以通过图形界面和命令行界面访问，这两者都嵌入在同一个可执行文件中。您可以直接通过命令行参数提供选项，也可以通过使用 --project_path path/to/project.ini 参数提供包含选项的 .ini 项目配置文件。要启动 GUI 应用程序，请执行 colmap gui 或直接指定项目配置为 colmap gui --project_path path/to/project.ini 以避免在 GUI 中进行繁琐的选择。要列出命令行可用的不同命令，请执行 colmap help。例如，要从命令行运行特征提取，您必须执行 colmap feature_extractor。图形用户界面和命令行界面部分提供了有关可用命令的更多详细信息。

### 命令行界面



命令行界面提供了对 COLMAP 所有功能的访问，适用于自动化脚本编写。每个核心功能都作为 colmap 可执行文件的一个命令来实现。运行 colmap -h 可以列出可用的命令（在 Windows 下运行 COLMAP.bat -h）。请注意，如果您从 CMake 构建文件夹运行 COLMAP，可执行文件位于 ./src/colmap/exe/colmap。要启动图形用户界面，请运行 colmap gui。

[命令行界面 — COLMAP 3.11-dev 文档](https://colmap.github.io/cli.html)

假设以以下结构存储了项目的图像：

![](C:\Users\董子能\AppData\Roaming\marktext\images\2024-08-06-09-42-23-image.png)

自动重建工具的命令为：

![](C:\Users\董子能\AppData\Roaming\marktext\images\2024-08-06-09-42-53-image.png)

### 细节

#### 数据结构

COLMAP 假设所有输入图像都位于一个输入目录中，并且可能包含嵌套的子目录。它递归地考虑存储在该目录中的所有图像，并支持各种不同的图像格式（请参阅 FreeImage）。其他文件将被自动忽略。如果需要高性能，建议将非图像文件分离开。图像通过其相对文件路径唯一标识。对于后续处理，如图像去畸变或稠密重建，相对文件夹结构应保持不变。COLMAP 不会修改输入图像或目录，所有提取的数据都存储在一个自包含的 SQLite 数据库文件中（请参阅数据库格式）。

第一步是通过运行预构建的二进制文件启动 COLMAP 的图形用户界面（Windows: COLMAP.bat，Mac: COLMAP.app）或通过在 CMake 构建文件夹中执行 ./src/colmap/exe/colmap gui。接下来，通过选择 File（文件） > New project（新建项目）创建一个新项目。在此对话框中，您必须选择存储数据库的位置和包含输入图像的文件夹。为了方便，您可以通过选择 File（文件） > Save project（保存项目）将整个项目设置保存到配置文件中。项目配置存储了数据库和图像文件夹的绝对路径信息以及其他参数设置。如果您决定移动数据库或图像文件夹，必须通过创建新项目相应地更改路径。或者，可以在您选择的文本编辑器中直接修改生成的 .ini 配置文件。要重新打开现有项目，只需选择 File（文件） > Open project（打开项目），打开配置文件，所有参数设置将被恢复。请注意，所有 COLMAP 可执行文件都可以从命令行启动，可以通过命令行参数指定单独设置，或者提供项目配置文件的路径（请参阅界面）。

![](C:\Users\董子能\AppData\Roaming\marktext\images\2024-08-05-16-10-02-image.png)

#### 特征检测和提取

第一步，特征检测/提取在图像中找到稀疏的特征点，并使用数值描述符描述它们的外观。COLMAP 在一个步骤中导入图像并执行特征检测/提取，以便只从磁盘加载一次图像。

接下来，选择 Processing（处理）> Extract features（提取特征）。在此对话框中，您首先需要决定使用的内在相机模型。您可以自动从嵌入的EXIF信息中提取焦距信息，或手动指定内在参数，例如在实验室校准中获得的参数。如果图像具有部分EXIF信息，COLMAP 会尝试在大型相机模型数据库中自动查找缺失的相机规格。如果所有图像都是由相同的物理相机以相同的变焦因子拍摄的，建议在所有图像之间共享内在参数。请注意，如果在所有图像之间共享相同的相机模型，但并非所有图像具有相同的大小或EXIF焦距，程序将非正常退出。如果有几组图像共享相同的内在相机参数，您也可以在以后轻松修改相机模型（请参阅数据库管理）。如果不确定在此步骤中选择什么，直接使用默认参数即可。

您可以从图像中检测和提取新特征，或从文本文件中导入现有特征。COLMAP 在GPU或CPU上提取SIFT [lowe04] 特征。GPU版本需要连接显示器，而CPU版本推荐在服务器上使用。一般而言，GPU版本更优，因为它具有定制的特征检测模式，在高对比度图像的情况下通常会产生更高质量的特征。如果导入现有特征，每个图像旁边必须有一个文本文件（例如，/path/to/image1.jpg 和 /path/to/image1.jpg.txt），格式如下：

![](C:\Users\董子能\AppData\Roaming\marktext\images\2024-08-05-21-58-16-image.png)

其中 X、Y、SCALE、ORIENTATION 是浮点数，D_1...D_128 范围内的值 0...255. 该文件应有 NUM_FEATURES行 每个功能一行。例如，如果图像有 4 个特征，则文本 文件应如下所示：

![](C:\Users\董子能\AppData\Roaming\marktext\images\2024-08-05-21-58-32-image.png)

请注意，根据惯例，图像的左上角坐标为 (0, 0)，最左上角像素的中心坐标为 (0.5, 0.5)。如果需要为大量图像集合导入特征，直接使用您喜欢的脚本语言访问数据库效率会更高（请参阅数据库格式）。

如果您已设置好所有选项，选择 Extract（提取）并等待提取完成或取消。如果在提取过程中取消，下次为同一项目提取图像时，COLMAP 会自动从中断处继续。这也允许您向现有项目/重建中添加图像。在这种情况下，使用共享的内在参数时，请务必验证相机参数。

所有提取的数据将存储在数据库文件中，可以在数据库管理工具中查看/管理（请参阅数据库管理），或者专家用户可以直接使用 SQLite 进行修改（请参阅数据库格式）。

#### 特征匹配和几何验证

第二步，特征匹配和几何验证在不同图像中的特征点之间找到对应关系。

请选择 Processing（处理）> Match features（匹配特征），然后选择为不同输入场景提供的匹配模式之一：

1. **Exhaustive Matching（穷尽匹配）**：
   
   - 如果数据集中的图像数量相对较少（最多几百张），这种匹配模式应该足够快，并能带来最佳的重建结果。在这种模式下，每张图像都会与其他所有图像进行匹配，同时块大小决定了从磁盘加载到内存中的图像数量。

2. **Sequential Matching（顺序匹配）**：
   
   - 如果图像是按顺序获取的，例如通过摄像机拍摄的视频帧，这种模式很有用。在这种情况下，连续的帧有视觉重叠，因此无需对所有图像对进行穷尽匹配。相反，连续捕获的图像相互匹配。这种匹配模式基于词汇树内置了循环检测，每隔N张图像（loop_detection_period）与其视觉上最相似的图像（loop_detection_num_images）进行匹配。注意，图像文件名必须按顺序排列（例如，image0001.jpg，image0002.jpg，等等）。数据库中的顺序无关紧要，因为图像会根据文件名明确排序。循环检测需要一个预训练的词汇树，可以从 [https://demuc.de/colmap/](https://demuc.de/colmap/) 下载。

3. **Vocabulary Tree Matching（词汇树匹配）**：
   
   - 在这种匹配模式中，每张图像使用带有空间重新排名的词汇树与其视觉最近邻进行匹配。这是大型图像集合（数千张）的推荐匹配模式。这需要一个预训练的词汇树，可以从 [https://demuc.de/colmap/](https://demuc.de/colmap/) 下载。

4. **Spatial Matching（空间匹配）**：
   
   - 这种匹配模式将每张图像与其空间最近邻进行匹配。空间位置可以在数据库管理中手动设置。默认情况下，COLMAP 也会从 EXIF 中提取 GPS 信息，并将其用于空间最近邻搜索。如果有准确的先验位置信息，这是推荐的匹配模式。

5. **Transitive Matching（传递匹配）**：
   
   - 这种匹配模式使用已有的特征匹配的传递关系来生成更完整的匹配图。如果图像 A 与图像 B 匹配，B 与 C 匹配，则此匹配器尝试直接匹配 A 与 C。

6. **Custom Matching（自定义匹配）**：
   
   - 此模式允许指定单独的图像对进行匹配或导入单独的特征匹配。要指定图像对，需要提供一个文本文件，每行包含一对图像：

```plaintext
image1.jpg image2.jpg
image3.jpg image4.jpg
...
```

选择适当的匹配模式后，等待特征匹配和几何验证完成。

其中，image1.jpg 是图像文件夹中的相对路径。您有两种选项来导入单个特征匹配：未经几何验证的原始特征匹配或已经几何验证的特征匹配。在这两种情况下，期望的格式如下：

```plaintext
image1.jpg image2.jpg
0 1
1 2
3 4

image1.jpg image3.jpg
0 1
1 2
3 4
4 5

...
```

其中，image1.jpg 是图像文件夹中的相对路径，数字对是各自图像中基于零的特征索引。如果需要为大型图像集合导入大量匹配，直接使用您选择的脚本语言访问数据库会更高效。

如果已设置好所有选项，选择 Match（匹配）并等待匹配完成或中途取消。请注意，根据图像数量、每张图像的特征数量以及选择的匹配模式，此步骤可能需要相当长的时间。穷尽匹配的预期时间范围从几十张图像的几分钟到几百张图像的几小时，再到几千张图像的几天或几周。如果取消匹配过程或在匹配后导入新图像，COLMAP 只会匹配之前未匹配过的图像对。跳过已匹配图像对的开销很低。这也允许在初始匹配后导入额外的图像进行匹配，并允许为同一数据集结合不同的匹配模式。

所有提取的数据将存储在数据库文件中，可以在数据库管理工具中查看/管理（请参阅数据库管理），或者专家用户可以直接使用 SQLite 进行修改（请参阅数据库格式）。

请注意，特征匹配需要 GPU，匹配过程中计算机的显示性能可能会显著降低。如果您的系统有多个支持 CUDA 的 GPU，可以使用 gpu_index 选项选择特定的 GPU。

#### 稀疏重建

在前两个步骤中生成场景图后，您可以通过选择 Reconstruction（重建）> Start（开始）启动增量重建过程。COLMAP 首先将所有提取的数据从数据库加载到内存中，并从一个初始图像对开始重建。然后，通过注册新图像和三角化新点逐步扩展场景。在这个重建过程中，结果会“实时”可视化。有关可用控件的更多详细信息，请参阅图形用户界面部分。如果并非所有图像都注册到同一个模型中，COLMAP 会尝试重建多个模型。可以从工具栏中的下拉菜单中选择不同的模型。如果不同模型有共同注册的图像，可以使用 model_converter 可执行文件将它们合并为一个重建（详情请参阅常见问题解答）。

理想情况下，重建过程顺利进行，所有图像都被注册。如果情况不是这样，建议：

- 进行额外的匹配。为了获得最佳效果，请使用穷尽匹配、启用引导匹配、增加词汇树匹配中的最近邻数量或增加顺序匹配中的重叠等。
- 如果 COLMAP 无法初始化，请手动选择一个初始图像对。选择 Reconstruction（重建）> Reconstruction options（重建选项）> Init（初始化），并从数据库管理工具中设置具有足够不同视点匹配的图像。 

#### 密集重建

在重建了场景的稀疏表示和输入图像的相机姿态之后，MVS（多视图立体匹配）现在可以恢复更密集的场景几何。COLMAP 具有集成的密集重建管道，用于为所有注册的图像生成深度和法线 不足，重建过程可能会不正常崩溃。请参阅常见问题解答（冻结和内存）以了解如何避免这些问题。请注意，重建的点云法线不能直接在 COLMAP 中可视化，但可以在 Meshlab 中通过启用 Render（渲染）> Show Normal/Curvature（显示法线/曲率）来查看。同样，重建的密集表面网格模型必须使用外部软件进行可视化。

要开始，先将您的稀疏 3D 模型导入 COLMAP（或在完成之前的稀疏重建步骤后选择重建的模型）。然后，选择 Reconstruction（重建）> Multi-view stereo（多视图立体）并选择一个空的或现有的工作区文件夹，该文件夹用于输出所有密集重建结果。第一步是去畸变图像，第二步是使用立体匹配计算深度和法线图，第三步是将深度和法线图融合成点云，最后是可选的点云网格化步骤。在立体重建过程中，由于计算负荷较重，显示可能会冻结，如果您的 GPU 内存不足，重建过程可能会不正常崩溃。请参阅常见问题解答（冻结和内存）以了解如何避免这些问题。请注意，重建的点云法线不能直接在 COLMAP 中可视化，但可以在 Meshlab 中通过启用 Render（渲染）> Show Normal/Curvature（显示法线/曲率）来查看。同样，重建的密集表面网格模型必须使用外部软件进行可视化。

除了内部的密集重建功能，COLMAP 还可以导出到其他几个密集重建库，如 CMVS/PMVS [furukawa10] 或 CMP-MVS [jancosek11]。请选择 Extras（附加功能）> Undistort images（图像去畸变）并选择合适的格式。输出文件夹包含重建和去畸变的图像。此外，文件夹中包含执行密集重建的示例 shell 脚本。要运行 PMVS2，执行以下命令：

shell

复制代码

`./path/to/pmvs2 /path/to/undistortion/folder/pmvs/ option-all`

其中，/path/to/undistortion/folder 是在去畸变对话框中选择的文件夹。在上述命令行参数中，请确保不要忘记在 /path/to/undistortion/folder/pmvs/ 的末尾加上斜杠。

对于大型数据集，您可能需要首先运行 CMVS 将场景分成更易管理的部分，然后运行 COLMAP 或 PMVS2。请参阅去畸变输出文件夹中的示例 shell 脚本，以了解如何结合 COLMAP 或 PMVS2 运行 CMVS。此外，还有许多支持 COLMAP 输出的外部库：

- CMVS/PMVS [furukawa10]
- CMP-MVS [jancosek11]
- Line3D++ [hofer16] 
